---
title: "Interactive Data Story - Group Six"
author: "Annie Staker, Edgar Lopez, Scott Fry"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message=FALSE)
```

## Introduction

Introduction to the problem and description of data available

In this project we sought to understand whether bias existed in US faculty 
salary data on the basis of sex. To do this, we sought to answer four questions: 

1. Did sex bias exist at the university in the 1995?
2. Has sex bias existed in the starting salaries of faculty members (salaries in 
the year hired)?
3. Has sex bias existed in granting salary increases between 1990 -1995?
4. Has sex bias existed in granting promotions from Associate to full Professor?

The data set includes information on faculty employed at a university in 1995. 
In addition to a salary, sex, and an identifier, the data set contains 
information on highest degree attained, year highest degree was attained, field, 
start year, rank, case number, and whether the faculty member has an 
administrative role.

## Methods

To address these questions, we developed two deliverables: an interactive web 
application and an interactive data story. The interactive web application was 
written using RShiny and answers Question 3. It is available 
[here](https://0195a0d2-2cd4-6de1-648a-a84a43189d4d.share.connect.posit.cloud/). Additionally, a writeup discussing Question 3 is included in our data submission. Interactive data stories were written for 
Questions 1, 2, and 4 and are included in the Results section below.

## Results

Present results for each scientific question
- Interactive Data Stories Go Here

The results presented in this section are interactive data stories for Questions 
1, 2, and 4. The results and summary for Question 3 are part of the interactive 
web application.

### Question 1

We want to answer the question, "Did sex bias exist at the university in 1995?"

To investigate this we will use linear regression. First, let's build a simple linear regression model to look at the relationship between sex (the explanatory variable) and salary (the response variable) for the data in 1995.

Note that for all hypothesis tests in this section we will be using an alpha value of $\alpha=0.05$.

```{r echo = T, results = 'hide'}
library(dplyr)    # for data manipulation
library(ggplot2)  # for plotting
library(scales)   # for percentage scales in some plots (e.g. scale_y_continuous(labels=percent))
```

```{r}
salary_data <- read.table(file = "salary.txt", header = TRUE)
salary_data_1995 <- salary_data[salary_data$year == 95, ]

simple_model <- lm(salary ~ sex, data=salary_data_1995)
summary(simple_model)
```
This appears to show clear evidence that there is an association between salary and sex. If we let $\beta_1$ be the coefficient of the variable indicating a male, we reject the null hypothesis that $\beta_1 = 0$ with an alpha value less than $2e-16$. Further, this model indicates that moving from female to male results in a salary 
increase of $1334.73. However, the adjusted R-squared value is low - just 0.08129. Could there be lurking variables we should consider?

We will address these question by adding more explanatory variables to the linear regression. To decide which variables to include, we did some exploratory data analysis. We looked for variables that were not evenly distributed by sex.

```{r}
p_rank_95_percent <- ggplot(salary_data_1995, aes(x = rank, fill = sex)) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = percent) +
  labs(title = "Academic Rank in 1995 - Percentage by Sex",
       x = "Rank",
       y = "Percentage") +
  theme_minimal()
print(p_rank_95_percent) # rank

yrdeg_means <- salary_data_1995 %>%
  group_by(sex) %>%
  summarise(mean_yrdeg = mean(yrdeg, na.rm = TRUE))

p7 <- ggplot(salary_data_1995, aes(yrdeg))
plot_of_sex_vs_yrdeg <- p7 + geom_density(aes(fill = factor(sex)), alpha = 0.8) + 
    geom_vline(
    data = yrdeg_means,
    aes(xintercept = mean_yrdeg),
    linetype = "dashed",
    linewidth = 1
  ) +
  labs(title = "Sex vs Year when Highest Degree was attained in 1995 (Density Plot)", 
       x = "Year in which Highest Degree was Attained",
       fill = "sex")
print(plot_of_sex_vs_yrdeg) # yrdeg

salary_data_1995_prop <- salary_data_1995 %>%
  count(field, sex) %>%  # Count occurrences per field and sex
  group_by(field) %>%  
  mutate(prop = n / sum(n))  # Compute proportion
p_field_bar <- ggplot(salary_data_1995_prop, aes(x = field, y = prop, fill = sex)) +
  geom_bar(stat = "identity", position = "stack") +  # Use "stack" for a stacked bar chart
  labs(title = "Fields of Work by Sex in 1995 (Stacked Proportion)",
       x = "Field",
       y = "Proportion") +
  theme_minimal()
print(p_field_bar) # field

p_hire_dens <- ggplot(salary_data_1995, aes(x = startyr, fill = sex)) +
  geom_density(alpha = 0.3, position = "fill") +
  labs(title = "Percentage of Hires by Start Year For Employees in 1995",
       x = "Year of Hire",
       y = "Proportion") +
  scale_y_continuous(labels = percent) +
  theme_minimal()
print(p_hire_dens) # startyr

salary_data_1995_prop <- salary_data_1995 %>%
  count(admin, sex) %>%  # Count occurrences per field and sex
  group_by(admin) %>%  
  mutate(prop = n / sum(n))  # Compute proportion
p_field_bar <- ggplot(salary_data_1995_prop, aes(x = admin, y = prop, fill = sex)) +
  geom_bar(stat = "identity", position = "stack") +  # Use "stack" for a stacked bar chart
  labs(title = "Possession of Admin Status by Sex in 1995 (Stacked Proportion)",
       x = "Admin",
       y = "Proportion") +
  theme_minimal()
print(p_field_bar) # admin

salary_data_1995_prop <- salary_data_1995 %>%
  count(deg, sex) %>%  # Count occurrences per field and sex
  group_by(deg) %>%  
  mutate(prop = n / sum(n))  # Compute proportion
p_field_bar <- ggplot(salary_data_1995_prop, aes(x = deg, y = prop, fill = sex)) +
  geom_bar(stat = "identity", position = "stack") +  # Use "stack" for a stacked bar chart
  labs(title = "Deg Status by Sex in 1995 (Stacked Proportion)",
       x = "Deg",
       y = "Proportion") +
  theme_minimal()
print(p_field_bar) # deg
```

From these graphs, we want to look at rank, field, deg, yrdeg, startyr, and admin. Before we do this, however, let's consider yrdeg and startyr. It is likely that these variables are related -- the year an employee got their degree is likely related to their start year. We will fit models with only one of these variables and see what we see.

First, we fit a model without yrdeg:

```{r}
model_no_yrdeg <- lm(salary ~ sex + rank + field + deg + startyr + admin, data=salary_data_1995)
summary(model_no_yrdeg)
```
We see that the p-value for startyr, $0.303$, is higher than the alpha value $\alpha = 0.05$. This means that with this model we fail to reject the null hypothesis that the coefficient of startyr equals $0$.

Next, we will fit a model with yrdeg but without startyr:

```{r}
model_no_startyr <- lm(salary ~ sex + rank + field + deg + yrdeg + admin, data=salary_data_1995)
summary(model_no_startyr)
```
In this model, the p-value for yrdeg, $1.34e-08$, is less than the alpha value $0.05$. We reject the null hypothesis that the coefficient of yrdeg is not equal to $0$. In fact, every coefficient in this model is statistically significantly different than $0$. We will use this model to discuss differences in salary.

The Adjusted R-Squared value in the previous two models are similar - 0.5122 versus 0.5217. These are both much higher than the Adjusted R-Squared of 0.08129 from the original model using simple linear regression.

For each indicator variable in our model, the coefficient represents the average difference in salary between the group represented by the indicator variable and the reference group(s), holding other variables constant. In this model, the variables rankFull, fieldProf, and admin have the highest coefficients. These each correspond to the most prestigious class in each categorical variable.

Let's revisit our graphs of these three fields with respect to sex.

```{r}
p_rank_95_percent <- ggplot(salary_data_1995, aes(x = rank, fill = sex)) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = percent) +
  labs(title = "Academic Rank in 1995 - Percentage by Sex",
       x = "Rank",
       y = "Percentage") +
  theme_minimal()
print(p_rank_95_percent)

salary_data_1995_prop <- salary_data_1995 %>%
  count(field, sex) %>%  # Count occurrences per field and sex
  group_by(field) %>%  
  mutate(prop = n / sum(n))  # Compute proportion
p_field_bar <- ggplot(salary_data_1995_prop, aes(x = field, y = prop, fill = sex)) +
  geom_bar(stat = "identity", position = "stack") +  # Use "stack" for a stacked bar chart
  labs(title = "Fields of Work by Sex in 1995 (Stacked Proportion)",
       x = "Field",
       y = "Proportion") +
  theme_minimal()
print(p_field_bar)

salary_data_1995_prop <- salary_data_1995 %>%
  count(admin, sex) %>%  # Count occurrences per field and sex
  group_by(admin) %>%  
  mutate(prop = n / sum(n))  # Compute proportion
p_field_bar <- ggplot(salary_data_1995_prop, aes(x = admin, y = prop, fill = sex)) +
  geom_bar(stat = "identity", position = "stack") +  # Use "stack" for a stacked bar chart
  labs(title = "Possession of Admin Status by Sex in 1995 (Stacked Proportion)",
       x = "Admin",
       y = "Proportion") +
  theme_minimal()
print(p_field_bar)
```

We see that all three of these categories have trends by sex. In particular, the variables with the highest coefficients in our model -- full rank, field professor, and being an admin -- have a higher proportion of males than the other categories in each variable.

Thus we conclude that the difference in salary is associated not just with sex but with many variables. However, these other explanatory variables are not independent of sex themselves -- the more prestigious the category gets, the higher the proportion of male candidates gets. Perhaps the discrepancy in salary is not due solely to sex but also the fact that there are a smaller proportion of female employees in the more prestigious categories.

### Question 2

```{r load libraries, include=FALSE}
library(tidyverse)
library(scales)
library(gt)
library(lmtest)
library(sandwich)
library(sjPlot)

suppressMessages(library(tidyverse))
suppressMessages(library(gt))
options(dplyr.summarise.inform = FALSE)
```

```{r Load Data, echo = FALSE}
salary <- read_fwf(
  file = "salary.txt",
  col_positions = fwf_cols(
    case = c(1,5),
    id = c(6,10),
    sex = c(11,17),
    deg = c(18,23),
    yrdeg = c(24,29),
    field = c(30,35),
    startyr = c(36,43),
    year = c(44,48),
    rank = c(49,55),
    admin = c(56,61),
    salary = c(62,71)),
  col_types = "ccffifiiffn",
  skip = 1)
```

```{r analyze data, echo = FALSE}
salary_by_id <- salary %>%
  group_by(id) %>%
  summarize(n())
```

We want to answer the question: "Has sex bias existed in the starting salaries of faculty members (salaries in the year hired)?"

We'll define our null hypothesis as there being no difference in starting monthly salary of faculty due to the sex and our alternative hypothesis as there being a difference in starting monthly salary of faculty by sex.

Looking at our data set, the first step is to identify what data we need to answer the question. Since this question is focused on whether sex bias existed in the starting salaries of faculty members we need to focus our analysis on the salary for each faculty member in the year they started at the university which is represented by the variable *startyr*.

As described above, the full data set consists of one record per faculty member per year between 1976 and 1995. Faculty member data is only available for the years they are employed at the university and faculty members may have between 1 and 20 records per faculty member. There are 19,792 records and 1,597 unique faculty members. 

A quick frequency table of the startyr variable shows that the startyr variable goes back to 1948 while we only have salary data back to 1976. This suggests that we will not be able to include all of the faculty members in determining whether there is sex bias in the starting salaries of faculty members since we do not observe the starting salaries of faculty members hired before 1976. 

```{r startyr range, echo = FALSE}
table(salary$startyr)
```
In order to select the right data for faculty members that we have starting salary data for we'll want to filter the full salary data for the condition *year = startyr*. This will remove faculty members whose starting year is before 1976 (since the year variable range is 76 to 95) and it will include only a single record for each faculty member that represents the starting monthly salary as of their starting year. Since the variables for rank and whether a faculty member has an administrative role may change by year, this filter will ensure that we capture the rank of the faculty member and whether they are serving in an administrative role as of the year they are hired.

```{r filter to required data, echo = FALSE}
salary_starting_year <- filter(salary, startyr == year)
```

After applying the filter described above we have a data set with 1,107 records representing 1,107 unique faculty members and their monthly salary and other characteristics as of the year they started at the university.

The str command gives a quick overview of the data set and identifies the variables, variable types, levels (for factor variables) and some example data for each variable. 

```{r data summary, echo = FALSE}
str(salary_starting_year)
```
In order to focus on the most important variables it will be helpful to remove some variables that don't have any value in our analysis. As an example, the case variable is a row number, which won't be useful in this analysis. Similarly the id variable will be unique for each faculty member and because of the structure of the data and filter that we applied earlier requiring *year = startyr* we will have one unique id per faculty member included. We can also drop either the year or startyr variable since they will have the same variable for every record. The code below confirms that we have unique values for case and id and that startyr is the same as year for every record. It subsequently drops the case, id, and year variables.

```{r data cleanup, echo = FALSE}
print(paste0("The number of rows in the data is: ",nrow(salary_starting_year),"."))
print(paste0("The number of unique values for the case variable is: ",n_distinct(salary_starting_year$case),"."))
print(paste0("The number of unique values for the id variable is: ",n_distinct(salary_starting_year$id),"."))
print(paste0("The number of records where year = startyr is: ", sum(salary_starting_year$startyr == salary_starting_year$year),"."))

salary_starting_year <- salary_starting_year %>%
  select(-c(id, case, year))
```
Now that we have filtered to the right data set, some descriptive statistics will help us select the right model. I start with a table for the factor variables.

```{r descriptive statistics table 1D, echo = FALSE}
  gtsummary::tbl_summary(select(salary_starting_year, -c(startyr, yrdeg, salary)))
```

We notice that our data contains about one-third female faculty and two-thirds male faculty. For the degree variable, PhD is by far the most common degree with 84% of the faculty holding a PhD and Other and Professional degrees accounting for the remaining 16% of faculty. The field is tilted towards Other representing about two-thirds of records and about one-sixth Arts and one-fifth Professional. The rank is heavily weighted towards assistant professors. Less than 5% of the faculty had administrative responsibilities.

The box plot below helps show the distribution of the starting monthly salary as well as the presence of some outliers. 

```{r descriptive statistics monthly salary 1D, echo = FALSE}
  boxplot(salary_starting_year$salary, main = "Starting Monthly Salary for Faculty", ylab = "Monthly Salary (USD)")
```

Seeing the count of yrdeg shows that we have more data for more recent years. We have the most records in 1991 with 108 and the fewest records in 1982 with 22.

```{r descriptive statistics startyr 1D, echo = FALSE}
  ggplot(salary_starting_year, aes(startyr)) + 
  geom_bar() + 
  theme_minimal() + 
  labs(x = "Starting Year", y = "Count", title = "Frequency of Starting Year") +
  geom_text(stat='count', aes(label = after_stat(count)), vjust=-0.5)
```

The count of the year the highest degree was earned by the faculty shows the majority of degrees were earned between 1970 and 1990, which aligns with new professors starting between 1976 and 1995. The oldest degree was earned in 1948 and the latest in 1996.

```{r descriptive statistics highest degree 1D, echo = FALSE}
  ggplot(salary_starting_year, aes(yrdeg)) + 
  geom_bar() + 
  theme_minimal() + 
  labs(x = "Year Highest Degree was Earned", y = "Count", title = "Frequency of Year Highest Degree was Earned") +
  geom_text(stat='count', aes(label = after_stat(count)), vjust=-0.5, size = 3)
```

Given our primary goal is to understand the possibility of sex bias in salary it would be helpful to understand that fundamental relationship. The graph below shows all of the monthly starting salaries by year with red dots representing female faculty members and blue dots representing male faculty members.

```{r descriptive statistics salary by sex 2D dotplot, echo = FALSE}
  ggplot(salary_starting_year, aes(x = startyr, y = salary, color = sex)) + 
  geom_point() +
  theme_minimal() + 
  labs(title = "Starting Faculty Monthly Salary by Year and sex",
       x = "Year",
       y = "Monthly Salary")
```

From the graph above it appears that the salary for men may be higher, but it's difficult to tell because a lot of the points are overlapping. Adding the jitter feature to the dots makes it a little easier to distinguish where there is a high volume of dots present.

```{r descriptive statistics salary by sex 2D dotplot jitter, echo = FALSE}
  ggplot(salary_starting_year, aes(x = startyr, y = salary, color = sex)) + 
  geom_jitter(width = 0.1) +
  theme_minimal() + 
  labs(title = "Starting Faculty Monthly Salary by Year and sex",
       x = "Year",
       y = "Monthly Salary")
```

It's easier to tell that there are more outliers in the data, but adding a line representing the mean salary by year for each sex makes it even easier to distinguish between the two.

```{r descriptive statistics salary by sex 2D dotplot jitter meanline, echo = FALSE}
  salary_starting_year_mean_by_yrsex <- salary_starting_year %>% 
  group_by(startyr, sex) %>%
  summarize(mean_val = mean(salary))

  ggplot(salary_starting_year, aes(x = startyr, y = salary, color = sex)) + 
  geom_jitter(width = 0.1) +
  theme_minimal() + 
  labs(title = "Starting Faculty Monthly Salary by Year and sex",
       x = "Year",
       y = "Monthly Salary") + 
  geom_line(data = salary_starting_year_mean_by_yrsex, aes(x = startyr, y = mean_val, color = sex), linewidth = 1.5)
```

We can clearly tell that the average starting salary for male faculty is higher in every year than the average starting salary for female faculty. However, we can't yet conclude that the explanation for the different in average starting salary is bias. The relationship could be explained by other characteristics, for example, men could be more like to join the faculty with more experience or as higher ranked faculty or in more lucrative fields. We'll want to explore the relationships between these variables, starting salary, and sex in order to determine whether the difference in starting salary is explained by differences in other characteristics. We'll start this exploration by using descriptive statistics to evaluate the relationships between these variables. 

The graphs show the relationship between starting salary and rank and between rank and sex. The first graph shows that a higher rank is associated with a higher starting salary. The second chart shows that female faculty members are more likely to be hired into assistant professor positions rather than higher paying full professor or associate professor positions. This suggests that rank may be a variable that is accounting for some of the variability in starting salary by sex.

```{r descriptive statistics salary by rank and rank by sex 2D, echo = FALSE}
  salary_starting_year_mean_startyr_rank <- salary_starting_year %>% 
  group_by(startyr, rank) %>%
  summarize(mean_val = mean(salary))

  ggplot(salary_starting_year, aes(x = startyr, y = salary, color = rank)) + 
  geom_jitter(width = 0.1) +
  theme_minimal() + 
  labs(title = "Starting Faculty Monthly Salary by Year and Rank",
       x = "Year",
       y = "Monthly Salary") + 
  geom_line(data = salary_starting_year_mean_startyr_rank, aes(x = startyr, y = mean_val, color = rank), linewidth = 1.5)
  
  salary_year_sex_rank <- salary_starting_year %>%
  select(startyr, sex, rank) %>% # Select only the startyr, sex, and rank variables
  group_by(startyr, sex, rank) %>% 
  summarize(rank_count_by_year_sex = n()) %>% # Count the number of entries by year, sex, and rank
  ungroup() %>%
  group_by(startyr, sex) %>% 
  # Count the proportion of faculty in each field grouped by sex and year
  mutate(rank_proportion = rank_count_by_year_sex / sum(rank_count_by_year_sex)) %>% 
  select(-rank_count_by_year_sex)

ggplot(data = salary_year_sex_rank, aes(x = startyr, y = rank_proportion, fill = sex)) + # Use year as the x variable, sex as the grouping variable and the proportion as the height of the bar
  geom_bar(position = position_dodge(0.7), stat="identity", width = 0.7) + 
  facet_grid(rank ~ .) + # Facets the graph by field for easier comparison
  theme_light() + # Good theme for faceted charts
  labs(title = "Academic Rank Proportion by Starting Year and Sex") +
  ylab("Proportion of Faculty") + 
  xlab("Year") + 
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) # Changes the y-axis to show proportion as a percent
```

We'll do a similar analysis examining the relationship between starting salary and field and between field and sex. We observe that the Professional Field has a higher average starting salary followed by the Other and then Arts fields. When we look at the field distribution by sex we observe that female faculty members appear to have a lower proportion in the Professional field category and a higher proportion in the Arts field category compared to male faculty members. This suggests that field may also be a variable that is correlated with both salary and sex.

```{r descriptive statistics salary by field and field by sex 2D, echo = FALSE}
  salary_starting_year_mean_startyr_field <- salary_starting_year %>% 
  group_by(startyr, field) %>%
  summarize(mean_val = mean(salary))

  ggplot(salary_starting_year, aes(x = startyr, y = salary, color = field)) + 
  geom_jitter(width = 0.1) +
  theme_minimal() + 
  labs(title = "Starting Faculty Monthly Salary by Year and Field",
       x = "Year",
       y = "Monthly Salary") + 
  geom_line(data = salary_starting_year_mean_startyr_field, aes(x = startyr, y = mean_val, color = field), linewidth = 1.5)
  
  salary_year_sex_field <- salary_starting_year %>%
  select(startyr, sex, field) %>% # Select only the startyr, sex, and field variables
  group_by(startyr, sex, field) %>% 
  summarize(field_count_by_year_sex = n()) %>% # Count the number of entries by year, sex, and field
  ungroup() %>%
  group_by(startyr, sex) %>% 
  # Count the proportion of faculty in each field grouped by sex and year
  mutate(field_proportion = field_count_by_year_sex / sum(field_count_by_year_sex)) %>% 
  select(-field_count_by_year_sex)

ggplot(data = salary_year_sex_field, aes(x = startyr, y = field_proportion, fill = sex)) + # Use year as the x variable, sex as the grouping variable and the proportion as the height of the bar
  geom_bar(position = position_dodge(0.7), stat="identity", width = 0.7) + 
  facet_grid(field ~ .) + # Facets the graph by field for easier comparison
  theme_light() + # Good theme for faceted charts
  labs(title = "Academic field Proportion by Starting Year and Sex") +
  ylab("Proportion of Faculty") + 
  xlab("Year") + 
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) # Changes the y-axis to show proportion as a percent
```

After observing the relationships between salary and sex and between rank, salary, and sex and field, salary, and sex, we may conclude that female faculty members have lower average starting salaries, but that they are also hired into faculty ranks and fields that are correlated with lower starting salaries. This suggests that our approach must take into account the additional characteristics of the faculty members that may be affecting the direct relationship between starting salary and sex. One approach that can be used to analyze this type of relationship is multiple linear regression. It is an approach that allows us to see the relationship between two variables while controlling for additional variables. The initial model below uses monthly salary as the response variable and includes start year, sex, highest degree earned, rank, field, and administrative responsibility as the explanatory variables, we will be interested in determining whether sex is a meaningful variable in explaining variance in the monthly starting salary after controlling for the other explanatory variables.

```{r simple multiple linear regression, echo = FALSE}
model_1 <- lm(salary ~ startyr + sex + deg + rank + field + admin, data = salary_starting_year)
summary(model_1)
```
Looking at the model output we observe that all of our variables appear to be statistically significant at the 0.1% level with the exception of admin1 which indicates when a faculty member has administrative responsibilities which is significant at the 1% level and degPhD which indicates when the highest degree earned is a PhD which is not statistically significant at the 10% level. This initial model suggests that after controlling for the other variables male faculty members make approximately $215 more per month in terms of starting salary. 

Most of what we observed in the descriptive statistics analysis is borne out in the linear model. We see that full professors have higher salaries than Associate and Assistant professors and that Associate professors have higher salaries than Assistant Professors. We also observe that the salaries by field are ranked in descending order as Professional, Other, and Arts. As we expected having administrative responsibilities tends to have a positive impact on salary. One nuance here is that the startyr variable is helping explain the trend in starting salaries over time. As we observe that the average starting salary increases over time, the startyr variable is estimating a $194 average increase in monthly starting salary per year.

A few peculiarities of the model are showing up, for one, we see that having a PhD doesn't seem to affect the total starting salary, this may be because there is not a lot of variation within the degree variable, with 84% of all records showing PhDs, this may also be due to a correlation between the field variable and the degree variable where some of the highest starting salaries are in the Professional field which tends to have fewer PhDs and more Professional degrees, this suggests an interaction term between degree and field may be helpful to explain the variation.

One characteristic that we haven't accounted for in the analysis and didn't include in the initial linear model is the year that the faculty member got their highest degree *yrdeg*. The reason I excluded that variable from the initial model is that it is highly correlated with the year that a faculty member started at the university *startyr*. In the graph below we'll observe that the year that the faculty member got their highest degree is nearly always before the year they started at the university and that later startyr values are associated with later yrdeg values. The diagonal line in the graph below is where startyr = yrdeg, the dots below the line indicate faculty where the year they finished their highest degree is before the year they started at the university. Dots on the line indicate faculty where the year they finished their highest degree is the same as the year they started at the university and the few dots above the line indicate where the faculty member finished their highest degree after starting at the university.

```{r descriptive statistics startyr vs. yrdeg, echo = FALSE}
ggplot(data = salary_starting_year, aes(x = startyr, y = yrdeg)) + 
  geom_point() +
  theme_minimal() +
  geom_abline(aes(intercept = 0, slope = 1), linewidth = 1)
```

The problem with not using the yrdeg variable is that it may represent valuable information in that the difference between yrdeg and startyr represents experience a faculty member gained after they finished their highest degree, but before they started at the university. One solution to avoid multicollinearity in the model is to create a feature that captures the important information in the yrdeg variable. I recommend creating a variable that represents experience calculated as max(startyr-yrdeg, 0). The startyr-yrdeg calculation represents the years of experience. The reason I use the max calculation is to account for people that get their highest degree after starting on the faculty. I use zero years of experience in that case rather than a negative value. An alternative approach could be including a negative value or including an indicator for when startyr is less than yrdeg.

```{r experience variable, echo = FALSE}
salary_starting_year <- salary_starting_year %>%
  mutate(experience = ifelse(startyr-yrdeg<0,0,startyr-yrdeg))
```

The revised model below incorporates the experience variable and includes the interaction terms between degree and field.

```{r complex multiple linear regression, echo = FALSE}
model_2 <- lm(salary ~ startyr + experience + sex + deg*field + rank + admin, data = salary_starting_year)
summary(model_2)
```

Looking at the model output it doesn't appear that the interaction effect is having much of an impact, but the experience variable is explaining some of the variance. The overall model fit (Multiple R-squared) is seeing only a very small improvement.

The first ANOVA model below compares the original model and the model with the experience variable and the interaction effect between degree and field, it appears that the added variables are significant at the 0.1% level. I also created a model with the experience variable, but without the interaction term between degree and field, then used a second ANOVA model to compare the model with the experience variable and the interaction effect to the model with the experience variable and without the interaction effect. While the interaction effect appears significant at the 5% significance level I would recommend removing it from the model due to the fact that it adds a lot of complexity but not much explainability and one of the levels of the interaction effect between a Professional degree and the Arts field is completely empty (meaning there are no examples of faculty in their starting year with a Professional degree as their highest degree in the Arts field).

```{r compare multiple linear regression, echo = FALSE}
anova(model_1, model_2)

model_3 <- lm(salary ~ startyr + experience + sex + deg + field + rank + admin, data = salary_starting_year)
anova(model_2, model_3)

```
After this analysis I would recommend using model 3 which includes salary as the response variable and startyr, experience, sex, deg, field, rank, and admin as the explanatory variables.

The residual model graphs below suggest that we have some heteroskedasticity as the variance of the residuals increases as the predicted values increase. Looking at the QQ-plot and density plot we also have some large outliers that aren't as well explained by the model. The density plot looks approximately normal except for those large outliers to the right.

```{r evaluate model residuals, echo = FALSE}
summary(model_3)
plot(model_3$fitted.values, model_3$residuals)
qqnorm(residuals(model_3))
qqline(residuals(model_3))
plot(density(residuals(model_3)))
```

Given the heteroskedasticity I would recommend using robust errors for estimating the coefficients and confidence intervals.

```{r robust errors, echo = FALSE}
tab_model(model_3, vcov.fun = "HC1", show.se = TRUE)
```

The model analysis suggests that we reject the null hypothesis that sex does not have an impact on the starting salary of faculty at the university for faculty starting between 1976 and 1995. The 95% confidence interval estimate of the size of the impact using robust errors is \$86 - \$297 per month.

### Code Appendix 

```{r code appendix, , fig.show = 'hide', results = "hide"}

# Environment Setup

knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(scales)
library(gt)
library(lmtest)
library(sandwich)
library(sjPlot)

suppressMessages(library(tidyverse))
suppressMessages(library(gt))
options(dplyr.summarise.inform = FALSE)

# Load Data

salary <- read_fwf(
  file = "salary.txt",
  col_positions = fwf_cols(
    case = c(1,5),
    id = c(6,10),
    sex = c(11,17),
    deg = c(18,23),
    yrdeg = c(24,29),
    field = c(30,35),
    startyr = c(36,43),
    year = c(44,48),
    rank = c(49,55),
    admin = c(56,61),
    salary = c(62,71)),
  col_types = "ccffifiiffn",
  skip = 1)

# Startyr range

table(salary$startyr)

# Filter Data

salary_starting_year <- filter(salary, startyr == year)

# Data Summary

str(salary_starting_year)

# Data Clean-Up and Calculations

print(paste0("The number of rows in the data is: ",nrow(salary_starting_year),"."))
print(paste0("The number of unique values for the case variable is: ",n_distinct(salary_starting_year$case),"."))
print(paste0("The number of unique values for the id variable is: ",n_distinct(salary_starting_year$id),"."))
print(paste0("The number of records where year = startyr is: ", sum(salary_starting_year$startyr == salary_starting_year$year),"."))

salary_starting_year <- salary_starting_year %>%
  select(-c(id, case, year))

# Descriptive Statistics table for Factor Variables

gtsummary::tbl_summary(select(salary_starting_year, -c(startyr, yrdeg, salary)))

# Boxplot of monthly salary

boxplot(salary_starting_year$salary, main = "Starting Monthly Salary for Faculty", ylab = "Monthly Salary (USD)")

# Bar chart of startyr frequency

ggplot(salary_starting_year, aes(startyr)) + 
  geom_bar() + 
  theme_minimal() + 
  labs(x = "Starting Year", y = "Count", title = "Frequency of Starting Year") +
  geom_text(stat='count', aes(label = after_stat(count)), vjust=-0.5)

# Bar chart of yrdeg frequency

  ggplot(salary_starting_year, aes(yrdeg)) + 
  geom_bar() + 
  theme_minimal() + 
  labs(x = "Year Highest Degree was Earned", y = "Count", title = "Frequency of Year Highest Degree was Earned") +
  geom_text(stat='count', aes(label = after_stat(count)), vjust=-0.5, size = 3)

# Initial Chart - Starting Monthly Salary by Year and Gender
  
  ggplot(salary_starting_year, aes(x = startyr, y = salary, color = sex)) + 
  geom_point() +
  theme_minimal() + 
  labs(title = "Starting Faculty Monthly Salary by Year and sex",
       x = "Year",
       y = "Monthly Salary")

# Jitter Chart - Starting Monthly Salary by Year and Gender
  
  ggplot(salary_starting_year, aes(x = startyr, y = salary, color = sex)) + 
  geom_jitter(width = 0.1) +
  theme_minimal() + 
  labs(title = "Starting Faculty Monthly Salary by Year and sex",
       x = "Year",
       y = "Monthly Salary")

# Jitter Chart with Line - Starting Monthly Salary by Year and Gender
  
  salary_starting_year_mean_by_yrsex <- salary_starting_year %>% 
  group_by(startyr, sex) %>%
  summarize(mean_val = mean(salary))

  ggplot(salary_starting_year, aes(x = startyr, y = salary, color = sex)) + 
  geom_jitter(width = 0.1) +
  theme_minimal() + 
  labs(title = "Starting Faculty Monthly Salary by Year and sex",
       x = "Year",
       y = "Monthly Salary") + 
  geom_line(data = salary_starting_year_mean_by_yrsex, aes(x = startyr, y = mean_val, color = sex), linewidth = 1.5)

# Relationship between Salary and Rank and Rank and Gender
  
    salary_starting_year_mean_startyr_rank <- salary_starting_year %>% 
  group_by(startyr, rank) %>%
  summarize(mean_val = mean(salary))

  ggplot(salary_starting_year, aes(x = startyr, y = salary, color = rank)) + 
  geom_jitter(width = 0.1) +
  theme_minimal() + 
  labs(title = "Starting Faculty Monthly Salary by Year and Rank",
       x = "Year",
       y = "Monthly Salary") + 
  geom_line(data = salary_starting_year_mean_startyr_rank, aes(x = startyr, y = mean_val, color = rank), linewidth = 1.5)
  
  salary_year_sex_rank <- salary_starting_year %>%
  select(startyr, sex, rank) %>% # Select only the startyr, sex, and rank variables
  group_by(startyr, sex, rank) %>% 
  summarize(rank_count_by_year_sex = n()) %>% # Count the number of entries by year, sex, and rank
  ungroup() %>%
  group_by(startyr, sex) %>% 
  # Count the proportion of faculty in each field grouped by sex and year
  mutate(rank_proportion = rank_count_by_year_sex / sum(rank_count_by_year_sex)) %>% 
  select(-rank_count_by_year_sex)

ggplot(data = salary_year_sex_rank, aes(x = startyr, y = rank_proportion, fill = sex)) + # Use year as the x variable, sex as the grouping variable and the proportion as the height of the bar
  geom_bar(position = position_dodge(0.7), stat="identity", width = 0.7) + 
  facet_grid(rank ~ .) + # Facets the graph by field for easier comparison
  theme_light() + # Good theme for faceted charts
  labs(title = "Academic Rank Proportion by Starting Year and Sex") +
  ylab("Proportion of Faculty") + 
  xlab("Year") + 
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) # Changes the y-axis to show proportion as a percent

# Relationship between Salary and Field and Field and Gender

  salary_starting_year_mean_startyr_field <- salary_starting_year %>% 
  group_by(startyr, field) %>%
  summarize(mean_val = mean(salary))

  ggplot(salary_starting_year, aes(x = startyr, y = salary, color = field)) + 
  geom_jitter(width = 0.1) +
  theme_minimal() + 
  labs(title = "Starting Faculty Monthly Salary by Year and Field",
       x = "Year",
       y = "Monthly Salary") + 
  geom_line(data = salary_starting_year_mean_startyr_field, aes(x = startyr, y = mean_val, color = field), linewidth = 1.5)
  
  salary_year_sex_field <- salary_starting_year %>%
  select(startyr, sex, field) %>% # Select only the startyr, sex, and field variables
  group_by(startyr, sex, field) %>% 
  summarize(field_count_by_year_sex = n()) %>% # Count the number of entries by year, sex, and field
  ungroup() %>%
  group_by(startyr, sex) %>% 
  # Count the proportion of faculty in each field grouped by sex and year
  mutate(field_proportion = field_count_by_year_sex / sum(field_count_by_year_sex)) %>% 
  select(-field_count_by_year_sex)

ggplot(data = salary_year_sex_field, aes(x = startyr, y = field_proportion, fill = sex)) + # Use year as the x variable, sex as the grouping variable and the proportion as the height of the bar
  geom_bar(position = position_dodge(0.7), stat="identity", width = 0.7) + 
  facet_grid(field ~ .) + # Facets the graph by field for easier comparison
  theme_light() + # Good theme for faceted charts
  labs(title = "Academic field Proportion by Starting Year and Sex") +
  ylab("Proportion of Faculty") + 
  xlab("Year") + 
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) # Changes the y-axis to show proportion as a percent

# Model 1 and Summary

model_1 <- lm(salary ~ startyr + sex + deg + rank + field + admin, data = salary_starting_year)
summary(model_1)

# Startyr vs. degyr relationship

ggplot(data = salary_starting_year, aes(x = startyr, y = yrdeg)) + 
  geom_point() +
  theme_minimal() +
  geom_abline(aes(intercept = 0, slope = 1), linewidth = 1)

# Experience feature development

salary_starting_year <- salary_starting_year %>%
  mutate(experience = ifelse(startyr-yrdeg<0,0,startyr-yrdeg))

# Model 2 and Summary

model_2 <- lm(salary ~ startyr + experience + sex + deg*field + rank + admin, data = salary_starting_year)
summary(model_2)

# Anova Model Comparison

anova(model_1, model_2)

model_3 <- lm(salary ~ startyr + experience + sex + deg + field + rank + admin, data = salary_starting_year)
anova(model_2, model_3)

# Model 3 Summary and Residual Plots

summary(model_3)
plot(model_3$fitted.values, model_3$residuals)
qqnorm(residuals(model_3))
qqline(residuals(model_3))
plot(density(residuals(model_3)))

# Model 3 output with robust errors

tab_model(model_3, vcov.fun = "HC1", show.se = TRUE)

```

### Question 4
```{r}
library(dplyr)
library(readr)
library(tidyr)
library(ggplot2)
```
# Investigating Gender Bias in University Promotions

## Introduction

In this analysis, we will investigate whether gender bias exists in the promotion process from Associate Professor to Full Professor at a University. Using applied statistical methods, we will examine whether male and female faculty members have significant differences in promotion eligibility when controlling for relevant factors.

The question we aim to address is: **Does the University exhibit gender bias in granting promotions from Associate to Full Professor?**

## Methodology Overview

We will approach this analysis through the following steps:

1. **Data Preparation**: Filter the dataset to only include Professors who began at the university as Assistant Professors, were promoted to Associates and thus were eligible for promotion to Full professors. We will also establish a reasonable time threshold for employment at the university to be considered eligible for a Full promotion
3. **Statistical Analysis**: 
   - Simple logistic regression with gender as the sole predictor
   - Multiple logistic regression incorporating potential confounding variables

This methodical approach will allow us to determine if any observed differences in promotions can be attributed to gender bias or if they can be explained by other factors.

## Data Preparation

### Focusing on Assistant Professors

1. **Controlling for Unknown History**: By focusing on professors who started as Assistants, we eliminate the confounding factor of unknown prior history that might influence the promotion trajectory of those who joined the university directly as Associates. External hires at the Associate level may bring additional varying experiences and career achievements that could affect their promotion timelines.

2. **Sample Size Impact**: This filtering reduced our sample size - from 1188 to 600 professors for men (49.5% reduction) and from 409 to 332 professors for women (18.8% reduction). While this reduction limits our statistical power somewhat, it strengthens the internal validity of our analysis by creating a more homogeneous comparison group to address potential sex bias in promotions.


```{r}

salary_data <- read.table("salary.txt", header = TRUE)
# cat("Initial dataset dimensions:", dim(salary_data)[1], "rows")

n_professors <- length(unique(salary_data$id))
# cat("\nNumber of unique professors (IDs):", n_professors, "\n")

# Find professors by IDs that were Assistant at some point
assistant_ids <- salary_data %>%
  filter(rank == "Assist") %>%
  pull(id) %>%
  unique()
# cat("\nNumber of professors who were Assistant at some point:", length(assistant_ids), "\n")

# Filter the data to keep all rows for professors who were Assistant at some point
filtered_data <- salary_data %>%
  filter(id %in% assistant_ids)

# cat("\nGender distribution (unique professors):\n")
gender_distribution_o <- salary_data %>%
  select(id, sex) %>%
  distinct() %>%
  group_by(sex) %>%
  summarise(count = n()) %>%
  mutate(percentage = count / sum(count) * 100)
# print(gender_distribution_o)

# cat("\nGender distribution (unique professors):\n")
gender_distribution_f <- filtered_data %>%
  select(id, sex) %>%
  distinct() %>%
  group_by(sex) %>%
  summarise(count = n()) %>%
  mutate(percentage = count / sum(count) * 100)
# print(gender_distribution_f)
```

### Focusing on Associate Professors
In the second stage of our filtering process, we narrow our focus further to include only those professors who reached the Associate Professor rank at some point in their career at the university. This refinement filters out faculty members who remained at the Assistant level throughout the observation period, reducing our sample from 600 to 424 male professors (29.3% reduction) and from 332 to 184 female professors (44.6% reduction). This represents those who could potentially be promoted to Full Professor.
This targeted approach allows us to specifically examine the promotion patterns from Associate to Full Professor, which is the primary focus of our research question regarding potential gender bias in senior faculty advancement.

```{r}
# Find IDs of professors who were Associates at some point
associate_ids <- filtered_data %>%
  filter(rank == "Assoc") %>%
  pull(id) %>%
  unique()

# cat("Number of professors who were Associates at some point:", length(associate_ids), "\n")

# Filter to keep only those professors (but keep all their rows)
associate_data <- filtered_data %>%
  filter(id %in% associate_ids)

# Gender distribution of the Associate professors
gender_distribution_associate <- associate_data %>%
  select(id, sex) %>%
  distinct() %>%
  group_by(sex) %>%
  summarise(count = n()) %>%
  mutate(percentage = count / sum(count) * 100)

# cat("\nGender distribution of professors who became Associates:\n")
# print(gender_distribution_associate)


```

### Calculating Sufficient Time for Promotion Eligibility

In this step, we calculate the number of years each professor spent at the Associate rank. This calculation serves an important purpose: it allows us to filter out professors who did not spend sufficient time as Associates to be reasonably considered for promotion to Full Professor.

Using the distribution of actual promotion times, examining the mean time to promotion and its standard deviation among successful cases we establish 4 years as the minimum threshold for promotion consideration. Professors who spent less than 4 years as Associate are excluded from our final analysis dataset.

This filtering step ensures our analysis of potential gender bias focuses exclusively on professors who had a reasonable opportunity for promotion based on time. Without this control for time-based eligibility, our assessment of gender differences in promotion rates could be confounded by varying lengths of service at the Associate level.

```{r warning=FALSE}

promotion_years <- associate_data %>%
  group_by(id) %>%
  summarize(
    # First year as Associate
    first_assoc_year = min(year[rank == "Assoc"], na.rm = TRUE),
    
    # First year as Full (if applicable)
    first_full_year = min(year[rank == "Full"], na.rm = TRUE),

    # Check if they were ever promoted to Full
    promoted_to_full = any(rank == "Full"),
    
    # Count the number of years as Associate
    years_as_assoc = sum(rank == "Assoc", na.rm = TRUE),

    # Get gender (assuming it will be the same for all records of an ID)
    sex = first(sex)
  ) %>%
  # Replace infinite values with NA for professors who never became Full
  mutate(
    first_full_year = if_else(is.infinite(first_full_year), NA_real_, first_full_year)
  )

# Calculate the years it took to be promoted from Associate to Full
promotion_years <- promotion_years %>%
  mutate(
    # Calculate years from Associate to Full
    assoc_to_full = if_else(promoted_to_full, 
                           first_full_year - first_assoc_year,
                           NA_real_)
  )

# Calculate promotion time statistics by gender
promotion_time_by_gender <- promotion_years %>%
  filter(!is.na(assoc_to_full)) %>%
  group_by(sex) %>%
  summarize(
    n = n(),
    mean_years = mean(assoc_to_full),
    median_years = median(assoc_to_full),
    min_years = min(assoc_to_full),
    max_years = max(assoc_to_full),
    standard_deviation = sd(assoc_to_full)
  )

print(promotion_time_by_gender)

# Merge the promotion time back to the original data
lookup_table <- promotion_years %>%
  select(id, assoc_to_full, first_assoc_year, first_full_year, promoted_to_full, years_as_assoc)

associate_data_with_time <- associate_data %>%
  left_join(lookup_table, by = "id")

# Create a professor-level dataset with the requested variables
professor_summary_all <- associate_data_with_time %>%
  # Group by professor ID
  group_by(id) %>%
  # Keep first observation of each variable (they should be consistent within ID)
  summarize(
    sex = first(sex),
    deg = first(deg),
    yrdeg = first(yrdeg),
    field = first(field),
    startyr = first(startyr),
    first_assoc_year = first(first_assoc_year),
    assoc_to_full = first(assoc_to_full),
    first_full_year = first(first_full_year),
    promoted_to_full = first(promoted_to_full),
    years_as_assoc = first(years_as_assoc)
  )

# Filter out professors who spent less than 4 years as Associate
professor_summary <- professor_summary_all %>%
  filter(years_as_assoc >= 4)

```

## Statistical Analysis

### Initial Simple Model

After carefully filtering our dataset to include only professors who:
1. Began at the university as Assistant Professors
2. Were promoted to Associate Professor
3. Spent at least 4 years at the Associate rank (sufficient time for potential promotion)

We proceeded with a simple logistic regression analysis to examine potential gender bias in promotions from Associate to Full Professor. Initially we will only focus on sex as a predictor and compare it to a more complex model that includes additional variables.

```r
model <- glm(formula = promoted_to_full ~ sex, family = binomial(link = "logit"),
    data = professor_summary)
```

### Key Results

The simple model yielded the following results:

| Term | Estimate | Std. Error | z value | Pr(>&#124;z&#124;) |
|------|----------|------------|---------|-------------------|
| (Intercept) | -0.08456 | 0.16799 | -0.503 | 0.6147 |
| sexM | 0.43030 | 0.20148 | 2.136 | 0.0327 * |

The odds ratio for males compared to females is 1.54. This indicates that male professors have approximately 54% higher odds of being promoted to Full Professor compared to their female counterparts.

### Interpretation

These results suggest a statistically significant association between gender and promotion outcomes, with male faculty members having higher promotion rates than female faculty members. The p-value of 0.0327 indicates that this gender difference is unlikely to have occurred by chance.

### Next Steps

While these initial findings suggest potential gender bias, they do not account for other factors that might legitimately influence promotion. Our next step will be to develop a more complex logistic regression model that incorporates potential confounding variables. If the gender effect remains significant after controlling for these factors, it would provide stronger evidence of systemic bias in the promotion process.


```{r}
# Set female as the reference level
professor_summary$sex <- factor(professor_summary$sex, levels = c("F", "M"))

# Run simple logistic regression
simple_model <- glm(promoted_to_full ~ sex, 
            data = professor_summary, 
            family = binomial(link = "logit"))

# summary(simple_model)
```

## Complex Model with Confounding Variables

To properly assess whether gender bias exists in promotions, we expanded our analysis to include potential confounding variables that might legitimately influence promotion decisions.

### Complex Logistic Regression Model

We constructed a model including the following variables:
- Gender (sex)
- Degree type (deg)
- Year degree was obtained (yrdeg)
- Academic field (field)
- Year started at university (startyr)
- Year first promoted to Associate Professor (first_assoc_year)

The logistic regression formula was:
```r
promoted_to_full ~ sex + deg + yrdeg + field + startyr + first_assoc_year
```

### Key Results

The complex model yielded the following coefficients:

| Term | Estimate | Std. Error | z value | Pr(>&#124;z&#124;) |
|------|----------|------------|---------|-------------------|
| (Intercept) | 20.81779 | 2.32427 | 8.957 | < 2e-16 *** |
| sexM | 0.05828 | 0.23497 | 0.248 | 0.80412 |
| degPhD | 0.17510 | 0.37764 | 0.464 | 0.64288 |
| degProf | -0.17216 | 0.62061 | -0.277 | 0.78146 |
| yrdeg | 0.02457 | 0.03617 | 0.679 | 0.49700 |
| fieldOther | 0.22649 | 0.28523 | 0.794 | 0.42716 |
| fieldProf | 0.61141 | 0.36510 | 1.675 | 0.09401 . |
| startyr | 0.18100 | 0.05970 | 3.032 | 0.00243 ** |
| first_assoc_year | -0.43837 | 0.07185 | -6.101 | 1.05e-09 *** |

The adjusted odds ratio for males compared to females is 1.06 (95% CI: 0.67-1.68).

2. **Significant Predictors**:
   - **Year first promoted to Associate** (first_assoc_year): Strong negative effect (coefficient = -0.43837, p < 0.001), indicating professors promoted to Associate earlier were much more likely to achieve Full Professor rank.
   - **Year started at university** (startyr): Positive effect (coefficient = 0.18100, p = 0.00243), suggesting that when controlling for when they became Associates, professors who started at the institution more recently had better promotion outcomes.
   
3. **Marginally Significant Factor**:
   - **Professional Field** (fieldProf): Positive effect (coefficient = 0.61141, p = 0.09401), suggesting a trend toward higher promotion rates in this field compared to the reference field.

### Model Fit

The model demonstrates substantially better fit compared to the null model:
- Null deviance: 653.00 on 474 degrees of freedom
- Residual deviance: 531.86 on 466 degrees of freedom
- AIC: 549.86

This reduction in deviance indicates that our selected variables explain a meaningful portion of the variation in promotion outcomes.

### Interpretation

The key finding from this analysis is that after accounting for important career timing variables and other factors, there is no statistically significant evidence of gender bias in promotions from Associate to Full Professor. The small remaining difference between male and female promotion rates is well within the range of random variation.

The strongest predictors of promotion appear to be timing-related: when professors became Associates and when they started at the university. This suggests that timing, rather than gender, is the primary determinant of promotion to Full Professor at this university.

```{r}
# Ensure categorical variables are properly coded as factors
professor_summary$sex <- factor(professor_summary$sex, levels = c("F", "M"))
professor_summary$deg <- factor(professor_summary$deg)
professor_summary$field <- factor(professor_summary$field)

complex_model <- glm(promoted_to_full ~ sex + deg + yrdeg + field + startyr + first_assoc_year, 
                    data = professor_summary, 
                    family = binomial(link = "logit"))
# summary(complex_model)
```

## Comparing Models to Assess Gender Bias in Promotions

After analyzing our data with both simple and complex models, the critical step is to compare them systematically to determine whether the apparent gender differences in promotion rates represent genuine bias or are explained by other factors.

### ANOVA Comparison

To formally test whether the addition of confounding variables significantly improves model fit, we conducted an Analysis of Variance (ANOVA) comparison. The ANOVA test examines whether the reduction in deviance achieved by the complex model justifies the additional parameters.

**Null Hypothesis**: The additional variables in the complex model do not significantly improve model fit compared to the simple model with only gender.

**Results of Model Comparison (ANOVA)**:

| Model | Resid. Df | Resid. Dev | Df | Deviance | Pr(>Chi) |
|-------|-----------|------------|----|---------:|----------|
| 1     | 473       | 648.43     |    |          |          |
| 2     | 466       | 531.86     | 7  | 116.57   | < 2.2e-16 *** |

The ANOVA test reveals a highly significant improvement in model fit with the complex model (p < 2.2e-16), indicating that the additional variables collectively explain a substantial portion of the variation in promotion outcomes.

### Changes in Gender Effect

The comparison of gender coefficients between models provides crucial insights:

| Measure | Simple Model | Complex Model |
|---------|-------------:|-------------:|
| Coefficient | 0.4303 | 0.0583 |
| Odds Ratio | 1.5377 | 1.06 |
| 95% CI | 1.0365 to 2.2856 | 0.6674 to 1.6791 |
| p-value | 0.0327 | 0.8041 |

**Key Changes**:
- Absolute change in coefficient: -0.372
- Percent change: -86.5%

This dramatic reduction in the gender coefficient (86.5% decrease) indicates that the apparent gender effect observed in the simple model is largely explained by the confounding variables in the complex model.

Furthermore, the gender effect loses statistical significance in the complex model (p = 0.8041), and the confidence interval now includes 1.0, consistent with no effect. This transformation suggests that the initial gender difference was not due to bias in the promotion process but rather to differences in career timing and other factors between male and female faculty.

### Relative Importance of Predictors

The complex model reveals that timing variables have much stronger effects on promotion than gender:
- The year a professor first became an Associate (coefficient = -0.43837, p < 0.001)
- The year a professor started at the university (coefficient = 0.18100, p = 0.00243)
```{r}

gender_simple <- coef(simple_model)["sexM"]
gender_complex <- coef(complex_model)["sexM"]

odds_ratio_simple <- exp(gender_simple)
odds_ratio_complex <- exp(gender_complex)

ci_simple <- exp(confint(simple_model)["sexM", ])
ci_complex <- exp(confint(complex_model)["sexM", ])

change_absolute <- gender_complex - gender_simple
change_percent <- (gender_complex - gender_simple) / gender_simple * 100

# Create a summary of the comparison
cat("Comparison of Gender Effect Between Models\n")

#cat("Simple Model (Gender Only):\n")
#cat("  Coefficient:", round(gender_simple, 4), "\n")
#cat("  Odds Ratio:", round(odds_ratio_simple, 4), "\n")
#cat("  95% CI:", round(ci_simple[1], 4), "to", round(ci_simple[2], 4), "\n")
#cat("  p-value:", round(summary(simple_model)$coefficients["sexM", "Pr(>|z|)"], 4), "\n\n")

#cat("Complex Model (With Confounders):\n")
#cat("  Coefficient:", round(gender_complex, 4), "\n")
#cat("  Odds Ratio:", round(odds_ratio_complex, 4), "\n")
#cat("  95% CI:", round(ci_complex[1], 4), "to", round(ci_complex[2], 4), "\n")
#cat("  p-value:", round(summary(complex_model)$coefficients["sexM", "Pr(>|z|)"], 4), "\n\n")

#cat("Change in Gender Effect:\n")
#cat("  Absolute change in coefficient:", round(change_absolute, 4), "\n")
#cat("  Percent change:", round(change_percent, 1), "%\n\n")

model_comparison <- anova(simple_model, complex_model, test = "Chisq")
#cat("Model Comparison (ANOVA):\n")
#print(model_comparison)

plot_data <- data.frame(
  Model = c("Simple Model", "Complex Model"),
  Coefficient = c(gender_simple, gender_complex),
  LowerCI = c(log(ci_simple[1]), log(ci_complex[1])),
  UpperCI = c(log(ci_simple[2]), log(ci_complex[2])),
  Significant = c(
    summary(simple_model)$coefficients["sexM", "Pr(>|z|)"] < 0.05,
    summary(complex_model)$coefficients["sexM", "Pr(>|z|)"] < 0.05
  )
)

# Plot the gender coefficients with confidence intervals
ggplot(plot_data, aes(x = Model, y = Coefficient, color = Significant)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = LowerCI, ymax = UpperCI), width = 0.2) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
  labs(
    title = "Change in Gender Effect After Controlling for Confounders",
    y = "Log Odds Coefficient for Male Gender",
    caption = "Note: Coefficient of 0 indicates no gender effect"
  ) +
  scale_color_manual(values = c("black", "red"), 
                     labels = c("Not Significant", "Significant")) +
  theme_minimal() +
  theme(legend.title = element_blank())

ggsave("gender_effect_comparison.png", width = 8, height = 6)
```

## Conclusion: Assessment of Gender Bias in Faculty Promotions

After careful data preparation and statistical analysis, we fail to reject the null hypothesis that gender does not influence promotion from Associate to Full Professor when accounting for relevant career factors.

### Summary of Findings

Our initial analysis using a simple logistic regression model showed that male faculty appeared to have 1.54 times higher odds of promotion to Full Professor compared to female faculty. This statistically significant difference (p = 0.0327) might suggest gender bias when viewed in isolation.

However, when we controlled for confounding variables—including degree type, year of degree, academic field, start year at the university, and year of promotion to Associate Professor this apparent gender effect largely disappeared. The odds ratio decreased dramatically to 1.06 and was no longer statistically significant (p = 0.8041). The ANOVA comparison confirmed that these additional factors significantly improved model fit (p < 2.2e-16).

### Methodology Summary

Our study design incorporated several methodological strengths that enhance the validity of our findings:

1. **Homogeneous Sample Selection**: By limiting our analysis to professors who:
   - Began at the university as Assistant Professors
   - Were promoted to Associate Professor
   - Spent at least 4 years at the Associate rank
   We created a more comparable group of faculty members and controlled for potential selection effects.

2. **Comprehensive Modeling**: By incorporating multiple variables, we accounted for legitimate factors that might influence promotion decisions, allowing us to isolate any potential gender effect.

### Limitations

Despite our thorough approach, several limitations should be acknowledged:

1. **Salary Considerations**: This study did not incorporate salary data, which might reveal different patterns of gender disparities in academic compensation even in the absence of promotion bias.

2. **Quality Metrics**: We did not have access to data on publication records, teaching evaluations, or service contributions, which could further explain promotion patterns.

3. **Institutional Specificity**: Our findings are specific to this university and may not generalize to other institutions with different promotion practices and cultures.

### Implications

Based on our statistical findings, gender bias does not appear to be prevalent in promotion decisions from Associate to Full Professor at this institution when accounting for career timing and other relevant factors. The apparent gender disparities in raw promotion rates can be better explained by differences in career trajectories and fields.

This does not mean that gender equity has been fully achieved in academia. Rather, it suggests that efforts to address gender disparities in this specific context might be more effectively focused on understanding why gender differences exist in career timing and field distribution, and on ensuring equitable opportunities earlier in the academic pipeline.

Future research should explore factors influencing time to promotion at earlier career stages and examine whether gender differences exist in other aspects of faculty experience beyond promotion rates.


## Summary

In summary, we created interactive data stories to address Questions 1, 2, and 4. Our findings from each question are summarized below.

Question 1 Summary: Our initial analysis led us to believe that there was a difference in salary on the basis of sex. When we added more variables to our analysis, the results got more complicated. We concluded that the difference in salary is associated not just with sex but with many variables. However, these other explanatory variables are not independent of sex themselves -- the more prestigious the category gets, the higher the proportion of male candidates gets. It is possible that the discrepancy in salary is not due solely to sex but also the fact that there are a smaller proportion of female employees in the more prestigious categories.

Question 2 Summary: Initial exploratory data analysis identified that male faculty members had higher average starting salaries than female faculty members in all observed years (1976-1995). We also identified that field and rank were positively correlated with starting salary. Rank and field were also correlated with gender with more female faculty starting in lower ranked faculty positions (Assistant vs. Full Professor) that had lower salaries and fewer female faculty members in the Professional field which had the highest salaries. We explored a number of multiple linear regression models to explore the relationship between starting salary and gender while controlling for other explanatory variables. We ultimately rejected the null hypothesis that there was no gender bias in salary and estimated that the 95% confidence interval estimate was that male faculty earned between \$86 and \$297 higher starting salaries per month after controlling for all other variables.

Question 4 Summary: Our initial analysis of gender bias in promotions led us to believe that males had 1.54 times higher odds of promotion to Full Professor compared to female faculty. However, when we controlled for confounding variables this apparent gender effect largely disappeared and no longer became statistically significant.
